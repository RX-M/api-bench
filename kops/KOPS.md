## Configure a VM for kops

#### Prelim tasks

Install pip (need to install AWS CLI)

```
sudo apt-get update
sudo apt-get install python-pip
```

Create an ssh key, used by kops for connecting to AWS instances `ssh-keygen -t rsa`


#### Install AWS CLI tools (req. by kops)

Install AWS CLI & create config file using the kops AWS user ID & secret created in the AWS web portal

```
pip install --upgrade --user awscli
mkdir ~/.aws
vim ~/.aws/credentials
[default]
aws_access_key_id = <ACCESS_KEY_ID>
aws_secret_access_key = <SECRET_ACCESS_KEY>
```


#### Install Kops

Grab the kops binary and make it executable

```
wget https://github.com/kubernetes/kops/releases/download/1.6.0/kops-linux-amd64
sudo chmod +x kops-linux-amd64
sudo mv kops-linux-amd64 /usr/local/bin/kops
```


#### Install kubectl

Grab kubectl, make it executable and enable bash completion

```
curl -LO https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl
sudo chmod +x ./kubectl
sudo mv ./kubectl /usr/local/bin/kubectl
echo "source <(kubectl completion bash)" >> ~/.bashrc
```

## KOPS config & run

### Configure cluster state store

Create a bucket in S3 to store kops configs. Docs recommend versioning the bucket, hence the `01-`:
- `aws s3api create-bucket --bucket 01-kops-state-store --region us-east-1`

i.e. using `kops edit cluster --name rx-m.net --state s3://01-kops-state-store` pulls from this s3 bucket


#### Prepare local environment

Bypass the need for `--name` & `--state` flags by setting some environment variables (optional)

```
export NAME=rx-m.net
export KOPS_STATE_STORE=s3://01-kops-state-store
```

#### Basic iteration

Create a yaml config for a basic 3-node (1 Manager, 2 Node workers) cluster w/ lots of default settings:

- `kops create cluster --cloud=aws --zones=us-west-1c ${NAME}`
- `kops create cluster --cloud=aws --zones=us-west-1c --name=rx-m.net --state=s3://01-kops-state-store`

View/edit the yaml config generated by the create command:

- `kops edit cluster ${NAME}`
- `kops edit cluster rx-m.net --state=s3://01-kops-state-store`

Launch/update the cluster: `kops update cluster ${NAME} --yes` (remove `--yes` for dry run)

-  This action generates a config for `kubectl` in `.kube/config`

Delete the cluster: `kops delete cluster ${NAME} --yes`


#### Custom iteration

Notes about options used:
- master-count - _must_ be an odd number
- master-zones & zones - use comma-separated values to use multiple AZs
- Z1PKS0TBPA1WSF - ID of the rx-m dns zone at AWS

```
kops create cluster \
    --cloud=aws \
    --master-count=1 \
    --master-zones=us-west-1c \
    --master-size=t2.xlarge \
    --node-count=2 \
    --zones=us-west-1c \
    --node-size=t2.xlarge \
    --associate-public-ip=false \
    --api-loadbalancer-type=public \
    --dns-zone=Z1PKS0TBPA1WSF \
    --authorization=AlwaysAllow \
    --channel=stable \
    --networking=kubenet \
    ${NAME}
```

Flip `--associate-public-ip=false` (from true above) and add `--api-loadbalancer-type=public` to put the apiserver
behind an ELB and secure the cluster Masters/Nodes (kops enables ssh to all the cluster nodes from any IP)
